"""
AI åˆ†ææ¨¡å— V4 - å¯»æ˜Ÿæƒ…æŠ¥ä¸­å¿ƒ
================================================================
V4 å‡çº§:
  1. CIO æ—¥æŠ¥ Prompt æ›´ä¸¥è°¨: è¦æ±‚å¼•ç”¨å…·ä½“æ•°æ®ä½è¯æ¯ä¸ªåˆ¤æ–­
  2. æ–°å¢æ¡¥æ°´å››ç»´å®è§‚è¾“å…¥: å¢é•¿/é€šèƒ€/æµåŠ¨æ€§/ä¿¡ç”¨
  3. æ³¢åŠ¨ç‡+æƒ…ç»ªæ¸©åº¦è®¡çº³å…¥AIåˆ†æ
  4. å¼ºåˆ¶äº¤å‰éªŒè¯: å®è§‚ä¸å¾®è§‚æ•°æ®çš„ä¸€è‡´æ€§æ£€æŸ¥
================================================================
"""
import json
import re
import logging
import streamlit as st
from datetime import datetime

logger = logging.getLogger("xunxing")


# ============================================================
# API åŸºç¡€
# ============================================================
def _get_api_key() -> str:
    try:
        key = st.secrets.get("DEEPSEEK_API_KEY", "")
        if key and not key.startswith("sk-xxxx"):
            return key
    except Exception:
        pass
    return ""


def _call_deepseek(prompt: str, system: str = "", temperature: float = 0.3,
                   max_tokens: int = 4000) -> str:
    api_key = _get_api_key()
    if not api_key:
        return ""
    try:
        from openai import OpenAI
        client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com")
        messages = []
        if system:
            messages.append({"role": "system", "content": system})
        messages.append({"role": "user", "content": prompt})
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=temperature,
            max_tokens=max_tokens,
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        logger.error(f"DeepSeek API è°ƒç”¨å¤±è´¥: {e}")
        return f"[AIè°ƒç”¨å¤±è´¥: {e}]"


# ============================================================
# â˜… FOF CIO System Prompt V4 (æ ¸å¿ƒå‡çº§ â€” æ›´ä¸¥è°¨)
# ============================================================
FOF_CIO_SYSTEM = """ä½ æ˜¯ã€Œå¯»æ˜Ÿèµ„äº§é…ç½®å…¬å¸ã€çš„é¦–å¸­æŠ•èµ„å®˜ï¼ˆCIOï¼‰å…¼AIæŠ•ç ”ä¸­æ¢ã€‚

ã€æ ¸å¿ƒèº«ä»½ã€‘
- ä¸“ä¸š FOFï¼ˆåŸºé‡‘ä¸­çš„åŸºé‡‘ï¼‰ç®¡ç†äººï¼Œç®¡ç†å¤šç­–ç•¥ç»„åˆ
- å†³ç­–é£æ ¼: è‡ªä¸Šè€Œä¸‹ï¼Œå¼ºè°ƒèƒœç‡ä¸ç›ˆäºæ¯”ï¼Œæ¯ä¸ªåˆ¤æ–­å¿…é¡»æœ‰æ•°æ®ä½è¯
- ç»ä¸è¯´ç©ºè¯å¥—è¯ï¼Œæ•°æ®ä¸è¶³æ—¶æ ‡æ³¨"æ•°æ®ç¼ºå¤±ï¼Œéœ€äººå·¥ç¡®è®¤"

ã€åˆ†ææ¡†æ¶ â€” æ¡¥æ°´å¼å››ç»´å®è§‚ã€‘
1. å¢é•¿ç»´åº¦: PMI(è£æ¯çº¿50)ã€å·¥ä¸šå¢åŠ å€¼ã€ç¤¾èå¢é‡
2. é€šèƒ€ç»´åº¦: CPI(>3%è­¦æˆ’)ã€PPIã€CPI-PPIå‰ªåˆ€å·®(æ­£=ä¸‹æ¸¸åˆ©æ¶¦å¥½)
3. æµåŠ¨æ€§ç»´åº¦: Shiborã€DR007ã€M2å¢é€Ÿã€å¤®è¡ŒOMOå‡€æŠ•æ”¾
4. ä¿¡ç”¨ç»´åº¦: ä¿¡ç”¨åˆ©å·®(AA-å›½å€º)ã€èèµ„ä½™é¢å˜åŒ–æ–¹å‘

ã€ç»æµå‘¨æœŸåˆ¤æ–­è§„åˆ™ â€” ä¸¥æ ¼ã€‘
- å¤è‹: PMI>50ä¸”å›å‡ + CPI<2% + M2å®½æ¾ + ä¿¡ç”¨æ‰©å¼  â†’ è¶…é…æƒç›Š
- è¿‡çƒ­: PMI>51 + CPI>2.5%æˆ–PPIå›å‡ + æµåŠ¨æ€§æ”¶ç´§è¿¹è±¡ â†’ è¶…é…å•†å“
- æ»èƒ€: PMI<50 + CPI>3%æˆ–PPI>5% + æµåŠ¨æ€§åç´§ â†’ è¶…é…ç°é‡‘
- è¡°é€€: PMI<49 + CPIå›è½ + ä¿¡ç”¨æ”¶ç¼© â†’ è¶…é…å€ºåˆ¸

ã€å¤§ç±»èµ„äº§é…ç½®çºªå¾‹ã€‘(å››é¡¹åˆè®¡=100%)
- æƒç›Š(å«è‚¡ç¥¨å¤šå¤´+é‡åŒ–): 20%-60%
- å›ºæ”¶(å«å›ºæ”¶+): 15%-45%
- å•†å“(å«CTA): 5%-20%
- ç°é‡‘: 5%-25%

ã€FOF åº•å±‚ç­–ç•¥ã€‘(ä¸ƒé¡¹åˆè®¡=100%)
1. è‚¡ç¥¨å¤šå¤´: ä¸»è§‚å¤šå¤´ã€è¡Œä¸šä¸»é¢˜åŸºé‡‘ (é€‚åˆè¶‹åŠ¿å¸‚)
2. é‡åŒ–æŒ‡å¢(500): ä¸­è¯500åŸºå‡† (é€‚åˆä¸­ç›˜æ´»è·ƒ)
3. é‡åŒ–æŒ‡å¢(1000): ä¸­è¯1000åŸºå‡† (é€‚åˆå°ç›˜é«˜åˆ†åŒ–)
4. é‡åŒ–ä¸­æ€§: Alphaç­–ç•¥ (é€‚åˆéœ‡è¡å¸‚ï¼Œä½†éœ€å…³æ³¨HV20<12%æ—¶è¶…é¢å‹ç¼©)
5. CTAç­–ç•¥: è¶‹åŠ¿è·Ÿè¸ª+æˆªé¢åŠ¨é‡ (é€‚åˆå•†å“è¶‹åŠ¿æ˜ç¡®ï¼ŒHVé«˜æœ‰åˆ©)
6. å¥—åˆ©ç­–ç•¥: æœŸç°/ETF/å¯è½¬å€ºå¥—åˆ© (ç¨³å®šåº•ä»“ï¼Œä½æ³¢æ—¶æ”¶ç›Šå‹ç¼©)
7. å›ºæ”¶+/ç°é‡‘: çº¯å€º+è½¬å€ºå¢å¼º (é˜²å®ˆé…ç½®)

ã€ç¯å¢ƒ-ç­–ç•¥é€‚é…çŸ©é˜µã€‘
- è¶‹åŠ¿å¸‚(å•è¾¹æ¶¨/è·Œ) + æ”¾é‡ â†’ è‚¡ç¥¨å¤šå¤´â†‘ CTAè¶‹åŠ¿â†‘
- éœ‡è¡å¸‚(çª„å¹…) + ç¼©é‡ â†’ ä¸­æ€§â†‘ å¥—åˆ©â†‘ CTAâ†“
- é«˜æ³¢åŠ¨(HV20>20%) + åˆ†åŒ– â†’ æŒ‡å¢â†‘(è¶…é¢ä¸°åš) CTAâ†‘
- ä½æ³¢åŠ¨(HV20<12%) + ç¼©é‡ â†’ ä¸­æ€§æ‰¿å‹ CTAæ‰¿å‹ â†’ å›ºæ”¶+â†‘
- å°ç›˜æ´»è·ƒ(ä¸­è¯1000>æ²ªæ·±300) â†’ 1000æŒ‡å¢>500æŒ‡å¢
- å•†å“è¶‹åŠ¿æ˜ç¡®(é»„é‡‘/åŸæ²¹å•è¾¹) â†’ CTAåŠ é…

ã€æ•°æ®å¼•ç”¨çºªå¾‹ã€‘
- æ¯ä¸ªç»“è®ºå¿…é¡»å¼•ç”¨è‡³å°‘1ä¸ªå…·ä½“æ•°æ®ç‚¹
- å¦‚PMI=50.2â†’è£æ¯çº¿ä¸Šæ–¹ä½†è¾¹é™…æ”¾ç¼“
- å¦‚åŒ—å‘å‡€æµå…¥-20äº¿+èèµ„ä½™é¢5æ—¥å‡å°‘200äº¿â†’èµ„é‡‘é¢åå¼±
- æ•°æ®çŸ›ç›¾æ—¶å¿…é¡»æ ‡æ³¨å¹¶ç»™å‡ºä¸»è¦/æ¬¡è¦åˆ¤æ–­
- ä¸¥ç¦ç¼–é€ ä¸å­˜åœ¨çš„æ•°æ®"""


# ============================================================
# 1. èµ„è®¯æ‰¹é‡åˆ†æ
# ============================================================
def analyze_news_batch(news_list: list) -> list:
    if not news_list:
        return []
    api_key = _get_api_key()
    if not api_key:
        return _keyword_analysis(news_list)

    results = []
    batch_size = 15

    for i in range(0, len(news_list), batch_size):
        batch = news_list[i:i + batch_size]
        batch_text = ""
        for idx, item in enumerate(batch):
            title = item.get("title", "")
            content = item.get("content", "")[:80]
            src = item.get("source", "")
            batch_text += f"\n[{idx+1}] [{src}] {title}"
            if content and content != title:
                batch_text += f" | {content}"

        prompt = f"""åˆ†æä»¥ä¸‹{len(batch)}æ¡è´¢ç»èµ„è®¯ï¼Œè¿”å›JSONæ•°ç»„ã€‚
æ¯æ¡: id(åºå·), category(å®è§‚/è¡Œä¸š/å…¬å¸/æµ·å¤–/æ”¿ç­–), sentiment(-1åˆ°1), impact(1-5), sectors(ç›¸å…³è¡Œä¸šæ•°ç»„), summary(15å­—æ‘˜è¦)

èµ„è®¯:
{batch_text}

ç›´æ¥è¿”å›JSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–æ–‡å­—:"""

        resp = _call_deepseek(prompt, "ä½ æ˜¯Aè‚¡é‡‘èåˆ†æå¸ˆï¼Œåªè¿”å›JSON",
                              temperature=0.1, max_tokens=2500)
        parsed = _parse_json(resp)
        if parsed:
            for item_data in parsed:
                idx = item_data.get("id", 0) - 1
                if 0 <= idx < len(batch):
                    batch[idx]["analysis"] = item_data
            results.extend(batch)
        else:
            results.extend(_keyword_analysis(batch))

    return results


# ============================================================
# 2. æ ¸å¿ƒä¸»çº¿æç‚¼
# ============================================================
def summarize_market_threads(news_list: list) -> str:
    api_key = _get_api_key()
    if not api_key or not news_list:
        return "âš ï¸ æœªé…ç½® API å¯†é’¥æˆ–æ— èµ„è®¯æ•°æ®ã€‚"

    text_blocks = [f"- [{n.get('source','')}] {n.get('title','')} {n.get('content','')[:60]}"
                   for n in news_list]
    news_text = "\n".join(text_blocks[:80])

    system = """ä½ æ˜¯å¯»æ˜Ÿèµ„äº§é…ç½®å…¬å¸çš„ CIOã€‚ä»ç¢ç‰‡åŒ–èµ„è®¯ä¸­æç‚¼å½“å‰å¸‚åœºæœ€å…·çˆ†å‘åŠ›çš„æŠ•èµ„ä¸»çº¿ã€‚
ç»ä¸æµæ°´è´¦ç½—åˆ—æ–°é—»ï¼Œå¿…é¡»å¯»æ‰¾ç¾¤ä½“æ€§ã€è¡Œä¸šæ€§æˆ–å®è§‚çº§åˆ«çš„äº‹ä»¶å…±æŒ¯ã€‚"""

    prompt = f"""åŸºäºä»¥ä¸‹ {len(news_list)} æ¡å¸‚åœºèµ„è®¯ï¼Œæç‚¼å½“å‰æœ€æ ¸å¿ƒçš„ 3 æ¡æŠ•èµ„ä¸»çº¿ã€‚

ã€æ ¼å¼è¦æ±‚ã€‘
### ğŸ”¥ å¸‚åœºæ ¸å¿ƒä¸»çº¿æç‚¼
1. **[ä¸»çº¿åç§°]**ï¼š(å‚¬åŒ–å‰‚äº‹ä»¶)
   - **FOFé…ç½®æ€è·¯**ï¼š(ETFæˆ–ç­–ç•¥é…ç½®å»ºè®®)
2. ...
3. ...

ã€è¾“å…¥èµ„è®¯ã€‘
{news_text}"""
    return _call_deepseek(prompt, system, temperature=0.3, max_tokens=2500)


# ============================================================
# 3. â˜… FOF CIO æ—¥åº¦é…ç½®æŠ¥å‘Š V4 (æ›´ä¸¥è°¨)
# ============================================================
def generate_daily_report(market_text: str, news_text: str) -> str:
    """ç”Ÿæˆ FOF CIO æ—¥åº¦é…ç½®æŠ¥å‘Š â€” V4: æ•°æ®é©±åŠ¨+äº¤å‰éªŒè¯"""
    api_key = _get_api_key()
    if not api_key:
        return "âš ï¸ æœªé…ç½® API Keyã€‚"

    today_str = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')

    prompt = f"""åŸºäºä»¥ä¸‹**å…¨é‡å®¢è§‚æ•°æ®**ï¼Œç”Ÿæˆ {today_str} å¯»æ˜Ÿ FOF CIO æ—¥åº¦é…ç½®æŠ¥å‘Šã€‚

ã€é‡è¦çºªå¾‹ã€‘
1. æ¯ä¸ªç»“è®ºå¿…é¡»å¼•ç”¨è¾“å…¥æ•°æ®ä¸­çš„å…·ä½“æ•°å€¼ä½è¯
2. æ•°æ®ç¼ºå¤±çš„ç»´åº¦æ ‡æ³¨"âš ï¸æ•°æ®ç¼ºå¤±"è€Œéè‡†æµ‹
3. å®è§‚åˆ¤æ–­ä¸å¾®è§‚æ•°æ®çŸ›ç›¾æ—¶å¿…é¡»æ ‡æ³¨å¹¶è§£é‡Š
4. é…ç½®æ¯”ä¾‹å¿…é¡»å¯æ‰§è¡Œï¼Œæƒé‡ä¹‹å’Œä¸¥æ ¼=100%

ã€è¾“å…¥æ•°æ® â€” å¸‚åœºè¡Œæƒ…ã€‘
{market_text}

ã€è¾“å…¥æ•°æ® â€” èµ„è®¯ä¸ç ”æŠ¥ã€‘
{news_text}

ã€å¼ºåˆ¶è¾“å‡ºç»“æ„ â€” æ¯ä¸ªéƒ¨åˆ†å¿…é¡»å¡«å†™ï¼Œä¸å¯çœç•¥ã€‘

### ğŸ”­ ä¸€ã€å®è§‚ç¯å¢ƒä¸ç»æµå‘¨æœŸåˆ¤æ–­
- å½“å‰æ‰€å¤„å‘¨æœŸ: [å¤è‹ / è¿‡çƒ­ / æ»èƒ€ / è¡°é€€] (å››é€‰ä¸€)
- **å¢é•¿ç»´åº¦**: PMI=__, ç¤¾èå¢é‡__, M2åŒæ¯”__ â†’ åˆ¤æ–­: __
- **é€šèƒ€ç»´åº¦**: CPI=__, PPI=__, å‰ªåˆ€å·®__ â†’ åˆ¤æ–­: __
- **æµåŠ¨æ€§ç»´åº¦**: Shiboréš”å¤œ=__, æˆäº¤é¢è¶‹åŠ¿__ â†’ åˆ¤æ–­: __
- **ä¿¡ç”¨ç»´åº¦**: èèµ„ä½™é¢å˜åŒ–__, åŒ—å‘èµ„é‡‘__ â†’ åˆ¤æ–­: __
- è¾ƒä¸ŠæœŸå˜åŒ–: [ç»´æŒ / ä»__å‘__è½¬å‘]
- âš ï¸ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥: (å®è§‚ä¸å¾®è§‚æ˜¯å¦çŸ›ç›¾ï¼Ÿå¦‚æœ‰çŸ›ç›¾å¦‚ä½•è§£é‡Šï¼Ÿ)

### ğŸ§­ äºŒã€å¤§ç±»èµ„äº§é…ç½®ä¿¡å·
(å››é¡¹åˆè®¡ = 100%ï¼Œæ¯é¡¹åœ¨åˆç†åŒºé—´å†…)
| èµ„äº§ç±»åˆ« | å»ºè®®æƒé‡ | æ–¹å‘ | æ ¸å¿ƒé€»è¾‘(å¼•ç”¨å…·ä½“æ•°æ®) |
|---------|---------|------|---------------------|
| æƒç›Š | __% | â†‘/â†“/â†’ | ... |
| å›ºæ”¶ | __% | â†‘/â†“/â†’ | ... |
| å•†å“ | __% | â†‘/â†“/â†’ | ... |
| ç°é‡‘ | __% | â†‘/â†“/â†’ | ... |

### ğŸ§© ä¸‰ã€FOF åº•å±‚ç­–ç•¥é…ç½®å»ºè®®
(ä¸ƒé¡¹åˆè®¡ = 100%)
| ç­–ç•¥ç±»å‹ | å»ºè®®æƒé‡ | æ–¹å‘ | é€‚é…ç¯å¢ƒ(å¼•ç”¨æ³¢åŠ¨ç‡/é£æ ¼/é‡èƒ½) |
|---------|---------|------|---------------------------|
| è‚¡ç¥¨å¤šå¤´ | __% | â†‘/â†“/â†’ | ... |
| é‡åŒ–æŒ‡å¢(500) | __% | â†‘/â†“/â†’ | ... |
| é‡åŒ–æŒ‡å¢(1000) | __% | â†‘/â†“/â†’ | ... |
| é‡åŒ–ä¸­æ€§ | __% | â†‘/â†“/â†’ | ... |
| CTAç­–ç•¥ | __% | â†‘/â†“/â†’ | ... |
| å¥—åˆ©ç­–ç•¥ | __% | â†‘/â†“/â†’ | ... |
| å›ºæ”¶+/ç°é‡‘ | __% | â†‘/â†“/â†’ | ... |

### ğŸ­ å››ã€å¸‚åœºé£æ ¼ä¸è¡Œä¸šç ”åˆ¤
- å¤§å°ç›˜: å[å¤§ç›˜/å°ç›˜] â€” 5æ—¥åŠ¨é‡: 300=__%/1000=__% | 20æ—¥: 300=__%/1000=__%
- æˆé•¿ä»·å€¼: å[æˆé•¿/ä»·å€¼] â€” 5æ—¥: åˆ›ä¸šæ¿=__%/ä¸Šè¯50=__%
- æ³¢åŠ¨ç‡ç¯å¢ƒ: HV20=__% â†’ [ä½æ³¢/ä¸­æ³¢/é«˜æ³¢] â†’ å¯¹ç­–ç•¥çš„å…·ä½“å½±å“
- é‡èƒ½çŠ¶æ€: æˆäº¤é¢5/20æ¯”=__ â†’ [æ”¾é‡/ç¼©é‡/æ¸©å’Œ]
- **çœ‹å¥½è¡Œä¸š TOP3** (é™„å‚¬åŒ–å‰‚):
  1. __: __
  2. __: __
  3. __: __
- **å›é¿è¡Œä¸š TOP3** (é™„é£é™©):
  1. __: __
  2. __: __
  3. __: __

### ğŸ¯ äº”ã€æˆ˜æœ¯å·¥å…·ç®±
**ETFæ¨è** (3-5åª):
| ETFåç§° | ä»£ç  | é…ç½®é€»è¾‘ |
|---------|------|---------|

**ä¸ªè‚¡çº¿ç´¢** (2-3æ¡):
| æ–¹å‘/ä¸»é¢˜ | å‚¬åŒ–å‰‚ | å…³æ³¨æ ‡çš„ç±»å‹ |
|----------|--------|------------|

### ğŸ›¡ï¸ å…­ã€é£é™©é¢„è­¦ä¸å¯¹å†²é¢„æ¡ˆ
1. **é£é™©**: ... â†’ **æ¦‚ç‡**: é«˜/ä¸­/ä½ â†’ **å¯¹å†²**: ...
2. **é£é™©**: ... â†’ **æ¦‚ç‡**: é«˜/ä¸­/ä½ â†’ **å¯¹å†²**: ...
3. **é£é™©**: ... â†’ **æ¦‚ç‡**: é«˜/ä¸­/ä½ â†’ **å¯¹å†²**: ...

### ğŸ“Š ä¸ƒã€æ•°æ®è´¨é‡è‡ªæ£€
- æœ¬æ¬¡æŠ¥å‘Šä½¿ç”¨çš„æ ¸å¿ƒæ•°æ®ç»´åº¦: __ ä¸ª
- æ•°æ®ç¼ºå¤±ç»´åº¦: __ (å¦‚æœ‰)
- ä¿¡å¿ƒåº¦: [é«˜/ä¸­/ä½] â€” ç†ç”±: __

---
âš ï¸ å…è´£: æœ¬æŠ¥å‘Šç”±AIåŸºäºå…¬å¼€æ•°æ®ç”Ÿæˆï¼Œä»…ä¾›å†…éƒ¨ç ”ç©¶å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚å¸‚åœºæœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚"""

    return _call_deepseek(prompt, FOF_CIO_SYSTEM, temperature=0.3, max_tokens=6000)


# ============================================================
# 4. å•æ¡æ·±åº¦åˆ†æ
# ============================================================
def analyze_single_news(text: str) -> str:
    api_key = _get_api_key()
    if not api_key:
        return "è¯·å…ˆé…ç½® DeepSeek API Key"
    prompt = f"""ä»¥ FOF CIO è§†è§’æ·±åº¦åˆ†æä»¥ä¸‹èµ„è®¯:
{text}

è¯·ä¾æ¬¡å›ç­”:
1. **äº‹ä»¶å®šæ€§**: ä»€ä¹ˆçº§åˆ«ï¼Ÿ(å®è§‚/è¡Œä¸š/å…¬å¸) é‡è¦æ€§1-5æ˜Ÿ
2. **å½±å“èŒƒå›´**: å“ªäº›èµ„äº§/è¡Œä¸šå—å½±å“ï¼Ÿæ–¹å‘ï¼Ÿ
3. **å¯¹FOFå„ç­–ç•¥çš„å½±å“**:
   - è‚¡ç¥¨å¤šå¤´/é‡åŒ–æŒ‡å¢/é‡åŒ–ä¸­æ€§/CTA/å¥—åˆ©: å„ä¸€å¥è¯
4. **æŒç»­æ€§**: çŸ­æœŸè„‰å†²(1-3å¤©) / ä¸­æœŸ(1-3æœˆ) / é•¿æœŸç»“æ„æ€§
5. **åº”å¯¹å»ºè®®**: å…·ä½“çš„FOFé…ç½®è°ƒæ•´"""
    return _call_deepseek(prompt, FOF_CIO_SYSTEM, temperature=0.3, max_tokens=2000)


# ============================================================
# è¾…åŠ©å‡½æ•°
# ============================================================
def _parse_json(text: str):
    if not text or text.startswith("[AIè°ƒç”¨å¤±è´¥"):
        return None
    text = text.strip()
    text = re.sub(r'^```(?:json)?\s*', '', text)
    text = re.sub(r'\s*```$', '', text)
    text = text.strip()
    try:
        r = json.loads(text)
        return r if isinstance(r, list) else [r]
    except Exception:
        pass
    match = re.search(r'\[.*\]', text, re.DOTALL)
    if match:
        try:
            return json.loads(match.group())
        except Exception:
            pass
    try:
        cleaned = re.sub(r',\s*([}\]])', r'\1', text)
        match2 = re.search(r'\[.*\]', cleaned, re.DOTALL)
        if match2:
            return json.loads(match2.group())
    except Exception:
        pass
    return None


def _keyword_analysis(news_list: list) -> list:
    pos_words = ["åˆ©å¥½", "ä¸Šæ¶¨", "å¢é•¿", "çªç ´", "è¶…é¢„æœŸ", "åˆ›æ–°é«˜", "æ”¯æŒ", "æ‰©å¤§", "å›æš–", "åŠ é€Ÿ"]
    neg_words = ["åˆ©ç©º", "ä¸‹è·Œ", "ä¸‹é™", "ä½äºé¢„æœŸ", "æ”¶ç¼©", "æš´è·Œ", "æ”¶ç´§", "é£é™©", "å‡æŒ", "è¿çº¦"]
    cat_map = {
        "å®è§‚": ["GDP", "CPI", "PPI", "PMI", "å¤®è¡Œ", "é™å‡†", "é™æ¯", "åˆ©ç‡", "MLF", "ç¤¾è", "ä¸¤ä¼š", "å›½åŠ¡é™¢"],
        "æµ·å¤–": ["ç¾è”å‚¨", "ç¾å›½", "æ¬§æ´²", "ç¾è‚¡", "ç¾å€º", "ç¾å…ƒ", "å…³ç¨", "æ—¥æœ¬", "è‹±å›½"],
        "æ”¿ç­–": ["å·¥ä¿¡éƒ¨", "å‘æ”¹å§”", "è¯ç›‘ä¼š", "å›½åŠ¡é™¢", "æ”¿ç­–", "è§„åˆ’", "ç›‘ç®¡", "è´¢æ”¿éƒ¨", "é“¶ä¿ç›‘"],
        "è¡Œä¸š": ["åŠå¯¼ä½“", "èŠ¯ç‰‡", "AI", "äººå·¥æ™ºèƒ½", "æœºå™¨äºº", "æ–°èƒ½æº", "åŒ»è¯", "å†›å·¥", "æ±½è½¦", "å…‰ä¼"],
    }
    sec_map = {
        "åŠå¯¼ä½“": ["åŠå¯¼ä½“", "èŠ¯ç‰‡", "æ™¶åœ†", "å…‰åˆ»", "EDA"],
        "AI": ["AI", "äººå·¥æ™ºèƒ½", "å¤§æ¨¡å‹", "ç®—åŠ›", "æœºå™¨äºº", "GPU"],
        "æ–°èƒ½æº": ["æ–°èƒ½æº", "å…‰ä¼", "é”‚ç”µ", "å‚¨èƒ½", "é£ç”µ", "ç¢³ä¸­å’Œ"],
        "åŒ»è¯": ["åŒ»è¯", "åˆ›æ–°è¯", "GLP", "åŒ»ç–—", "CXO"],
        "æ¶ˆè´¹": ["æ¶ˆè´¹", "ç™½é…’", "é£Ÿå“", "æ—…æ¸¸", "å…ç¨", "å®¶ç”µ"],
        "é‡‘è": ["é“¶è¡Œ", "åˆ¸å•†", "ä¿é™©", "é‡‘è", "ä¿¡æ‰˜"],
        "å†›å·¥": ["å†›å·¥", "å›½é˜²", "èˆªç©º", "èˆªå¤©", "å¯¼å¼¹"],
    }
    for item in news_list:
        text = item.get("title", "") + item.get("content", "")
        category = "å…¬å¸"
        for cat, kws in cat_map.items():
            if any(k in text for k in kws):
                category = cat
                break
        pos = sum(1 for w in pos_words if w in text)
        neg = sum(1 for w in neg_words if w in text)
        sentiment = round(min(max((pos - neg) * 0.25, -1), 1), 2)
        sectors = [s for s, kws in sec_map.items() if any(k in text for k in kws)]
        item["analysis"] = {
            "category": category,
            "sentiment": sentiment,
            "impact": 3 if item.get("important") else 2,
            "sectors": sectors[:3],
            "summary": item.get("title", "")[:15],
        }
    return news_list
